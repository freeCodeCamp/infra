apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: nginx-access-logs
  namespace: grafana
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {"type": "grafana", "uid": "-- Grafana --"},
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "custom": {"hideFrom": {"legend": false, "tooltip": false, "viz": false}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 16, "w": 24, "x": 0, "y": 0},
          "id": 13,
          "options": {
            "basemap": {"config": {}, "name": "Layer 0", "type": "default"},
            "controls": {"mouseWheelZoom": true, "showAttribution": true, "showZoom": true},
            "layers": [
              {
                "config": {
                  "showLegend": true,
                  "style": {
                    "color": {"fixed": "dark-green"},
                    "opacity": 0.4,
                    "size": {"field": "requests", "fixed": 5, "max": 15, "min": 2},
                    "symbol": {"fixed": "img/icons/marker/circle.svg", "mode": "fixed"}
                  }
                },
                "location": {"gazetteer": "public/build/gazetteer/countries.json", "lookup": "country_code", "mode": "lookup"},
                "name": "Layer 1",
                "tooltip": true,
                "type": "markers"
              }
            ],
            "tooltip": {"mode": "details"},
            "view": {"allLayers": true, "id": "zero", "lat": 0, "lon": 0, "zoom": 1}
          },
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT country_code, count() AS requests FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) AND country_code != '' GROUP BY country_code ORDER BY requests DESC",
              "refId": "A"
            }
          ],
          "title": "Traffic by Country",
          "type": "geomap"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 5, "w": 6, "x": 0, "y": 16},
          "id": 1,
          "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT count(*) AS total FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp)",
              "refId": "A"
            }
          ],
          "title": "Total Requests",
          "type": "stat"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "yellow", "value": 5}, {"color": "red", "value": 20}]},
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {"h": 5, "w": 6, "x": 6, "y": 16},
          "id": 2,
          "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT round(countIf(status >= 400 AND status != 444) * 100.0 / count(), 2) AS error_rate FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp)",
              "refId": "A"
            }
          ],
          "title": "Error Rate %",
          "type": "stat"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "yellow", "value": 500}, {"color": "red", "value": 1000}]},
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {"h": 5, "w": 6, "x": 12, "y": 16},
          "id": 3,
          "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT round(quantile(0.95)(request_time) * 1000, 2) AS p95_ms FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) AND request_time > 0",
              "refId": "A"
            }
          ],
          "title": "P95 Latency",
          "type": "stat"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}]},
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {"h": 5, "w": 6, "x": 18, "y": 16},
          "id": 4,
          "options": {"colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT round(countIf(cf_ray != '') * 100.0 / count(), 2) AS real_pct FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp)",
              "refId": "A"
            }
          ],
          "title": "Real Traffic %",
          "type": "stat"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "custom": {"align": "auto", "cellOptions": {"type": "auto"}, "inspect": false},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 21},
          "id": 9,
          "options": {"cellHeight": "sm", "showHeader": true},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT path, count() AS requests, round(avg(request_time) * 1000, 2) AS avg_ms, round(quantile(0.95)(request_time) * 1000, 2) AS p95_ms, countIf(status >= 400) AS errors FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) GROUP BY path ORDER BY requests DESC LIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Top Endpoints",
          "type": "table"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "custom": {"align": "auto", "cellOptions": {"type": "auto"}, "inspect": false},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 21},
          "id": 10,
          "options": {"cellHeight": "sm", "showHeader": true},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT path, count() AS requests, round(quantile(0.5)(request_time) * 1000, 2) AS p50_ms, round(quantile(0.95)(request_time) * 1000, 2) AS p95_ms, round(quantile(0.99)(request_time) * 1000, 2) AS p99_ms FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) AND request_time > 0 GROUP BY path HAVING requests > 5 ORDER BY p95_ms DESC LIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Slowest Endpoints (P95)",
          "type": "table"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "gradientMode": "opacity", "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "showPoints": "auto", "stacking": {"group": "A", "mode": "none"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 29},
          "id": 5,
          "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "single", "sort": "none"}},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT toStartOfMinute(timestamp) AS time, count() AS requests FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) GROUP BY time ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Requests Over Time",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 0, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "auto", "stacking": {"group": "A", "mode": "none"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}]},
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {"h": 9, "w": 24, "x": 0, "y": 39},
          "id": 8,
          "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "single", "sort": "none"}},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT toStartOfMinute(timestamp) AS time, round(quantile(0.5)(request_time) * 1000, 2) AS p50, round(quantile(0.95)(request_time) * 1000, 2) AS p95, round(quantile(0.99)(request_time) * 1000, 2) AS p99 FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) AND request_time > 0 GROUP BY time ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Latency Percentiles",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 0, "gradientMode": "opacity", "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "auto", "stacking": {"group": "A", "mode": "none"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 12, "w": 17, "x": 0, "y": 48},
          "id": 6,
          "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "single", "sort": "none"}},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT toStartOfMinute(timestamp) AS time, multiIf(status < 300, '2xx', status < 400, '3xx', status < 500, '4xx', status = 444, '444 blocked', '5xx') AS status_class, count() AS requests FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) GROUP BY time, status_class ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Status Codes Over Time",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {"color": {"mode": "palette-classic"}, "custom": {"hideFrom": {"legend": false, "tooltip": false, "viz": false}}, "mappings": []},
            "overrides": []
          },
          "gridPos": {"h": 12, "w": 7, "x": 17, "y": 48},
          "id": 7,
          "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "pieType": "pie", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "tooltip": {"mode": "single", "sort": "none"}},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT multiIf(status < 300, '2xx Success', status < 400, '3xx Redirect', status < 500, '4xx Client Error', status = 444, '444 Blocked', '5xx Server Error') AS status_class, count() AS count FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) GROUP BY status_class ORDER BY count DESC",
              "refId": "A"
            }
          ],
          "title": "Status Distribution",
          "type": "piechart"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 60},
          "id": 11,
          "options": {"displayMode": "gradient", "orientation": "horizontal", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showUnfilled": true},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT country_code, count() AS requests FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) AND country_code != '' GROUP BY country_code ORDER BY requests DESC LIMIT 15",
              "refId": "A"
            }
          ],
          "title": "Requests by Country",
          "type": "bargauge"
        },
        {
          "datasource": {"type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 0, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "auto", "stacking": {"group": "A", "mode": "none"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 80}]}
            },
            "overrides": []
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 60},
          "id": 12,
          "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "single", "sort": "none"}},
          "targets": [
            {
              "editorType": "sql",
              "format": 1,
              "queryType": "table",
              "rawSql": "SELECT toStartOfMinute(timestamp) AS time, multiIf(cf_ray != '', 'Cloudflare (Real)', status = 444, 'Blocked (444)', 'Direct/Bot') AS traffic_type, count() AS requests FROM logs_nginx_${deployment_env}.access WHERE $__timeFilter(timestamp) GROUP BY time, traffic_type ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Bot vs Real Traffic",
          "type": "timeseries"
        }
      ],
      "schemaVersion": 39,
      "tags": ["nginx", "logs", "clickhouse"],
      "templating": {
        "list": [
          {
            "current": {"text": "stg", "value": "stg"},
            "label": "Environment",
            "name": "deployment_env",
            "options": [
              {"selected": true, "text": "stg", "value": "stg"},
              {"selected": false, "text": "prd", "value": "prd"}
            ],
            "query": "stg,prd",
            "type": "custom"
          },
          {
            "current": {"text": "ClickHouse", "value": "af84wpojvuxhcb"},
            "label": "Data Source",
            "name": "DS_CLICKHOUSE",
            "query": "grafana-clickhouse-datasource",
            "type": "datasource"
          }
        ]
      },
      "time": {"from": "now-24h", "to": "now"},
      "timepicker": {},
      "timezone": "browser",
      "title": "NGINX Access Logs",
      "uid": "nginx-access-logs",
      "version": 1
    }

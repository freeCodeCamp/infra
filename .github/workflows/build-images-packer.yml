name: Build Machine Images

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'the region to build the image in'
        required: true
        default: 'eastus'
        type: choice
        options:
          - 'eastus'
          - 'westus'
          - 'centralus'
      child_image:
        description: 'the child image to build'
        required: true
        default: 'none'
        type: choice
        options:
          - 'none'
          - 'nginx'
          - 'nomad-consul'

jobs:
  build-images:
    name: Build Images
    runs-on: ubuntu-18.04

    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    outputs:
      output-build-ubuntu-image:
        ${{ steps.build-ubuntu-image.outputs.ubuntu_artifact_name }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3

      # Packer's official GitHub Actions are unstable & outdated, use a community action instead
      - name: Use latest Packer
        uses: hashicorp-contrib/setup-packer@ee5bed669b01ca73e42651206470fc355a60400d # tag=v2

      - name: Check Version
        run: |
          echo "Packer version: $(packer version)"

      - name: Build Ubuntu Image
        id: build-ubuntu-image
        run: |
          packer init \
          -var location=${{ inputs.region }} \
          ./images/machines/azure/ubuntu.pkr.hcl

          packer validate \
          -var location=${{ inputs.region }} \
          ./images/machines/azure/ubuntu.pkr.hcl

          packer build \
          -var location=${{ inputs.region }} \
          ./images/machines/azure/ubuntu.pkr.hcl

          UBUNTU_ARTIFACT_NAME=$(cat manifest.json | jq '.builds[].artifact_id' | sed -r 's|.*/(.*)"$|\1|')
          echo Building the next image with: $UBUNTU_ARTIFACT_NAME
          echo "::set-output name=ubuntu_artifact_name::$UBUNTU_ARTIFACT_NAME"

      - name: Build Child Image
        if: ${{ inputs.child_image != 'none' }}
        id: build-child-image
        run: |
          packer init \
          -var location=${{ inputs.region }} \
          -var custom_managed_image_name=${{ steps.build-ubuntu-image.outputs.ubuntu_artifact_name }} \
          ./images/machines/azure/${{ inputs.child_image }}.pkr.hcl

          packer validate \
          -var location=${{ inputs.region }} \
          -var custom_managed_image_name=${{ steps.build-ubuntu-image.outputs.ubuntu_artifact_name }} \
          ./images/machines/azure/${{ inputs.child_image }}.pkr.hcl

          packer build \
          -var location=${{ inputs.region }} \
          -var custom_managed_image_name=${{ steps.build-ubuntu-image.outputs.ubuntu_artifact_name }} \
          ./images/machines/azure/${{ inputs.child_image }}.pkr.hcl

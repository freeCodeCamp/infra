apiVersion: v1
kind: ConfigMap
metadata:
  name: gd-api-monitoring
  namespace: o11y
  labels:
    grafana_dashboard: '1'
    app: grafana
data:
  api-monitoring.json: '{"timezone":"utc","editable":true,"graphTooltip":0,"fiscalYearStartMonth":0,"schemaVersion":41,"templating":{"list":[{"type":"datasource","name":"LOKI_DATASOURCE","skipUrlSync":false,"multi":false,"allowCustomValue":true,"includeAll":false,"auto":false,"auto_min":"10s","auto_count":30,"query":"loki"},{"type":"query","name":"stack","skipUrlSync":false,"multi":false,"allowCustomValue":true,"includeAll":false,"auto":false,"auto_min":"10s","auto_count":30,"query":{"label":"swarm_stack","refId":"LokiVariableQueryEditor-VariableQuery","stream":"","type":1}}]},"annotations":{},"title":"freeCodeCamp API Dashboard","uid":"freecodecamp-api-v1","tags":["Node.js","API","Loki"],"refresh":"5m","time":{"from":"now-1h","to":"now"},"panels":[{"type":"stat","transparent":false,"repeatDirection":"h","title":"Total Requests","gridPos":{"x":0,"y":0,"w":5,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | __error__=\"\" [$__range]))","refId":"A","legendFormat":"Total Requests","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"green","value":0}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"Request Rate (RPS)","gridPos":{"x":5,"y":0,"w":4,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(rate({service=\"api\", swarm_stack=\"$stack\"} | json | __error__=\"\" [$__range]))","refId":"A","legendFormat":"Request Rate (RPS)","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"reqps","thresholds":{"mode":"absolute","steps":[{"color":"green","value":0}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"2xx","gridPos":{"x":9,"y":0,"w":3,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 200 | res_RES_STATUS_CODE < 300 | __error__=\"\" [$__range])) or vector(0)","refId":"A","legendFormat":"2xx","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"green","value":0}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"4xx","gridPos":{"x":12,"y":0,"w":3,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 400 | res_RES_STATUS_CODE < 500 | __error__=\"\" [$__range])) or vector(0)","refId":"A","legendFormat":"4xx","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"yellow","value":0}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"5xx","gridPos":{"x":15,"y":0,"w":3,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 500 | res_RES_STATUS_CODE < 600 | __error__=\"\" [$__range])) or vector(0)","refId":"A","legendFormat":"5xx","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"red","value":0}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"P95","gridPos":{"x":18,"y":0,"w":3,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"avg by() (quantile_over_time(0.95, {service=\"api\", swarm_stack=\"$stack\"} | json | unwrap res_RES_ELAPSED_TIME | __error__=\"\" [$__range])) / 1000","refId":"A","legendFormat":"p95","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"ms","thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"yellow","value":100},{"color":"red","value":500}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"stat","transparent":false,"repeatDirection":"h","title":"P99","gridPos":{"x":21,"y":0,"w":3,"h":4},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"avg by() (quantile_over_time(0.99, {service=\"api\", swarm_stack=\"$stack\"} | json | unwrap res_RES_ELAPSED_TIME | __error__=\"\" [$__range])) / 1000","refId":"A","legendFormat":"p99","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"ms","thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"yellow","value":200},{"color":"red","value":1000}]}},"overrides":[]},"options":{"graphMode":"none","colorMode":"value","justifyMode":"auto","textMode":"auto","wideLayout":true,"showPercentChange":true,"reduceOptions":{"calcs":["lastNotNull"],"values":false,"fields":""},"percentChangeColorMode":"standard","orientation":"auto","text":{"valueSize":40,"percentSize":10}}},{"type":"timeseries","transparent":false,"repeatDirection":"h","title":"Requests by Status","gridPos":{"x":0,"y":4,"w":12,"h":10},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 200 | res_RES_STATUS_CODE < 300 | __error__=\"\" [$__interval])) or vector(0)","refId":"A","legendFormat":"Success (2xx)","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}},{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 400 | res_RES_STATUS_CODE < 500 | __error__=\"\" [$__interval])) or vector(0)","refId":"B","legendFormat":"Client Error (4xx)","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}},{"expr":"sum(count_over_time({service=\"api\", swarm_stack=\"$stack\"} | json | res_RES_STATUS_CODE >= 500 | res_RES_STATUS_CODE < 600 | __error__=\"\" [$__interval])) or vector(0)","refId":"C","legendFormat":"Server Error (5xx)","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"short"},"overrides":[{"matcher":{"id":"byName","options":"Success (2xx)"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"green"}}]},{"matcher":{"id":"byName","options":"Client Error (4xx)"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"orange"}}]},{"matcher":{"id":"byName","options":"Server Error (5xx)"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"red"}}]}]},"options":{"legend":{"displayMode":"list","placement":"bottom","showLegend":true,"calcs":["lastNotNull","max","mean"]},"tooltip":{"mode":"multi","sort":"none"}}},{"type":"timeseries","transparent":false,"repeatDirection":"h","title":"Latency Percentiles","gridPos":{"x":12,"y":4,"w":12,"h":10},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"avg by() (quantile_over_time(0.5, {service=\"api\", swarm_stack=\"$stack\"} | json | unwrap res_RES_ELAPSED_TIME | __error__=\"\" [$__interval])) / 1000","refId":"A","legendFormat":"p50","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}},{"expr":"avg by() (quantile_over_time(0.95, {service=\"api\", swarm_stack=\"$stack\"} | json | unwrap res_RES_ELAPSED_TIME | __error__=\"\" [$__interval])) / 1000","refId":"B","legendFormat":"p95","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}},{"expr":"avg by() (quantile_over_time(0.99, {service=\"api\", swarm_stack=\"$stack\"} | json | unwrap res_RES_ELAPSED_TIME | __error__=\"\" [$__interval])) / 1000","refId":"C","legendFormat":"p99","datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"fieldConfig":{"defaults":{"unit":"ms"},"overrides":[{"matcher":{"id":"byName","options":"p50"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"green"}}]},{"matcher":{"id":"byName","options":"p95"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"yellow"}}]},{"matcher":{"id":"byName","options":"p99"},"properties":[{"id":"color","value":{"mode":"fixed","fixedColor":"red"}},{"id":"custom.lineWidth","value":2}]}]},"options":{"legend":{"displayMode":"list","placement":"bottom","showLegend":true,"calcs":["lastNotNull","max","mean"]},"tooltip":{"mode":"multi","sort":"none"}}},{"type":"table","transparent":false,"repeatDirection":"h","title":"Top 10 Endpoints by Request Count","gridPos":{"x":0,"y":14,"w":12,"h":12},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"topk(10,\n  sum by (clean_path) (\n    count_over_time(\n      {service=\"api\", swarm_stack=\"$stack\"}\n      | json\n      | label_format clean_path=`{{regexReplaceAll \"\\\\?.*\" .url \"\"}}`\n      | __error__=\"\"\n      [$__range]\n    )\n  )\n)","refId":"A","legendFormat":"{{clean_path}}","instant":true,"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"transformations":[{"id":"labelsToFields","options":{"mode":"columns","valueLabel":"clean_path"}},{"id":"organize","options":{"excludeByName":{"Time":true},"indexByName":{},"renameByName":{"clean_path":"Endpoint","Value":"Request Count"}}}],"options":{"frameIndex":0,"showHeader":true,"showTypeIcons":false,"footer":{"show":false,"reducer":[],"countRows":false},"cellHeight":"sm"},"fieldConfig":{"defaults":{"custom":{"align":"auto","inspect":false,"filterable":true}},"overrides":[]}},{"type":"table","transparent":false,"repeatDirection":"h","title":"Top 10 Slowest Endpoints (P95)","gridPos":{"x":12,"y":14,"w":12,"h":12},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"topk(10,\n  quantile_over_time(0.95,\n    {service=\"api\", swarm_stack=\"$stack\"}\n    | json\n    | label_format clean_path=`{{regexReplaceAll \"\\\\?.*\" .url \"\"}}`\n    | unwrap res_RES_ELAPSED_TIME\n    | __error__=\"\"\n    [$__range]\n  ) by (clean_path)\n) / 1000","refId":"A","legendFormat":"{{clean_path}}","instant":true,"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"transformations":[{"id":"labelsToFields","options":{"mode":"columns","valueLabel":"clean_path"}},{"id":"organize","options":{"excludeByName":{"Time":true},"indexByName":{},"renameByName":{"clean_path":"Endpoint","Value":"P95 Latency (ms)"}}}],"options":{"frameIndex":0,"showHeader":true,"showTypeIcons":false,"footer":{"show":false,"reducer":[],"countRows":false},"cellHeight":"sm"},"fieldConfig":{"defaults":{"custom":{"align":"auto","inspect":false,"filterable":true}},"overrides":[]}},{"type":"logs","transparent":false,"repeatDirection":"h","title":"Logs","gridPos":{"x":0,"y":26,"w":24,"h":22},"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"},"targets":[{"expr":"{service=\"api\", swarm_stack=\"$stack\"} | json","refId":"A","maxLines":1000,"datasource":{"type":"loki","uid":"${LOKI_DATASOURCE}"}}],"options":{"showLabels":false,"showCommonLabels":false,"showTime":true,"showLogContextToggle":false,"wrapLogMessage":false,"prettifyLogMessage":false,"enableLogDetails":false,"sortOrder":"Descending","dedupStrategy":"none"}}]}'

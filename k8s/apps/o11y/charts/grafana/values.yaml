persistence:
  enabled: true
  accessModes:
    - ReadWriteOnce
  size: 10Gi

# Fix upgrade hangs: Recreate strategy required for RWO PVCs
# This terminates old pod before creating new one, releasing the PVC
deploymentStrategy:
  type: Recreate

resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 500m
    memory: 1Gi

serviceAccount:
  name: o11y-grafana
  annotations: {}

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "3000"

envFromSecret: "o11y-secrets"

admin:
  existingSecret: "o11y-secrets"
  userKey: "GRAFANA_ADMIN_USER"
  passwordKey: "GRAFANA_ADMIN_PASSWORD"

grafana.ini:
  auth:
    disable_login_form: true
  users:
    auto_assign_org_role: Viewer
  paths:
    data: /var/lib/grafana/
    logs: /var/log/grafana
    plugins: /var/lib/grafana/plugins
    provisioning: /etc/grafana/provisioning
  server:
    domain: o11y.freecodecamp.net
    root_url: https://o11y.freecodecamp.net/grafana
    serve_from_sub_path: true
  auth.google:
    enabled: true
    allow_sign_up: true
    auto_login: true
    scopes: openid email profile
    auth_url: https://accounts.google.com/o/oauth2/v2/auth
    token_url: https://oauth2.googleapis.com/token
    api_url: https://openidconnect.googleapis.com/v1/userinfo
    allowed_domains: $__env{GRAFANA_GOOGLE_ALLOWED_DOMAIN}
    validate_hd: true
    use_pkce: true
    skip_org_role_sync: true
    allow_assign_grafana_admin: true
    client_id: $__env{GRAFANA_GOOGLE_CLIENT_ID}
    client_secret: $__env{GRAFANA_GOOGLE_CLIENT_SECRET}

datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.o11y.svc.cluster.local
        basicAuth: true
        basicAuthUser: loki
        secureJsonData:
          basicAuthPassword: $__env{LOKI_GATEWAY_PASSWORD}
          httpHeaderValue1: $__env{LOKI_TENANT_ID}
        jsonData:
          httpHeaderName1: X-Scope-OrgID
          timeout: 300
          maxLines: 50000
          derivedFields: []
        isDefault: true

      - name: Loki - OnCall
        type: loki
        access: proxy
        url: http://loki-gateway.o11y.svc.cluster.local
        basicAuth: true
        basicAuthUser: loki
        secureJsonData:
          basicAuthPassword: $__env{LOKI_GATEWAY_PASSWORD}
          httpHeaderValue1: fCC-o11y-oncall-v20250113-0001
        jsonData:
          httpHeaderName1: X-Scope-OrgID
          timeout: 300
          maxLines: 50000
          derivedFields: []
        isDefault: false

      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-kube-prometheus-prometheus.o11y.svc.cluster.local:9090
        isDefault: false
        jsonData:
          httpMethod: POST

sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: "1"
    searchNamespace: o11y
    folderAnnotation: grafana_folder
    provider:
      allowUiUpdates: true
      foldersFromFilesStructure: true

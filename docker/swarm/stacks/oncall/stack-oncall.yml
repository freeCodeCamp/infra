services:
  # CRON service
  svc-cronjob:
    image: crazymax/swarm-cronjob:1.14.0
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    environment:
      - "TZ=UTC"
      - "LOG_LEVEL=debug"
      - "LOG_JSON=false"
    deploy:
      placement:
        constraints:
          - "node.role == manager"

  svc-update:
    image: shizunge/gantry:2025.0813.0
    environment:
      - "TZ=UTC"
      - "GANTRY_NODE_NAME={{.Node.Hostname}}"
      - "GANTRY_SLEEP_SECONDS=0"
      - "GANTRY_LOG_LEVEL=INFO"
      - "GANTRY_SERVICES_FILTERS=label=org.freecodecamp.autoupdate"
      - "GANTRY_UPDATE_NUM_WORKERS=3"
      - "GANTRY_MANIFEST_NUM_WORKERS=5"
      - "GANTRY_MANIFEST_CMD=buildx"
      - "GANTRY_CLEANUP_IMAGES=true"      # Reliability - Auto-rollback on Failure
      - "GANTRY_ROLLBACK_ON_FAILURE=true"
      - "GANTRY_UPDATE_TIMEOUT_SECONDS=300"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "/home/freecodecamp/.docker/config.json:/root/.docker/config.json:ro"
    deploy:
      mode: replicated
      replicas: 0
      restart_policy:
        condition: none
      labels:
        - "swarm.cronjob.enable=true"
        - "swarm.cronjob.replicas=1"
        # Fire every hour, on the 45th minute mark
        - "swarm.cronjob.schedule=0 45 0/1 * * *"
        # Fire every 1 minute -- for testing
        # - "swarm.cronjob.schedule=* * * * *"
        - "swarm.cronjob.skip-running=true"
      placement:
        constraints:
          - "node.role == manager"

  # Cleanup Service - Weekly Failsafe
  # Runs as a backup to Gantry's automatic cleanup
  # Removes only resources older than 7 days (safer than aggressive prune)
  svc-cleanup:
    image: docker:29.0.0
    command:
      - "docker"
      - "system"
      - "prune"
      - "-f"
      - "--filter"
      - "until=168h"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      mode: global
      labels:
        - "swarm.cronjob.enable=true"
        # Fire every Monday at 03:30 UTC
        - "swarm.cronjob.schedule=0 30 3 * * 1"
        - "swarm.cronjob.skip-running=false"
      restart_policy:
        condition: none
